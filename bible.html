<!DOCTYPE html>
<html>
  <head>
    <meta charset=utf-8 />
    <title>The OAuth Bible</title>
    <link href='http://fonts.googleapis.com/css?family=UnifrakturMaguntia|Open+Sans:300italic,400italic,600italic,700italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href="assets/css/index.css" rel='stylesheet' type='text/css' />
  </head>
<body>
  
  <section class="container rounded">
    <header>
      <h1>The OAuth Bible</h1>
    </header>
    
    <section class="seperator foreword bloodorange">
      <p>I tried to make this as understandable as possible for any party reading it which means that the wording, references, and terminology used may not reflect that of a technical paper or resource. Excuse me if you may for I wish all to understand this, and not just those with a degree in understanding technical jargon.</p>
    </section>
    
    <nav class="toc" id="table-of-contents">
      <ol>
        <li><h4>Reference</h4>
          <ol>
            <li page="1"><a href="#terminology--reference">Terminology</a></li>
            <li page="5"><a href="#signed-requests">Signed Requests</a></li>
          </ol>
        </li>
        <li><h4>OAuth 1.0a</h4>
          <ol>
            <li page="10"><a href="#oauth-10a-one-legged">One Legged</a></li>
            <li page="15"><a href="#oauth-10a-two-legged">Two Legged</a></li>
            <li page="20"><a href="#oauth-10a-three-legged">Three Legged</a></li>
            <li page="25"><a href="#oauth-10a-echo">Echo</a></li>
            <li page="30"><a href="#oauth-10a-xauth">xAuth</a></li>
          </ol>
        </li>
        <li><h4>OAuth2</h4>
          <ol>
            <li page="35"><a href="#oauth-2-two-legged">Two-Legged</a></li>
            <li page="40"><a href="#oauth-2-three-legged">Three-Legged</a></li>
            <li page="45"><a href="#oauth-2-refresh-token">Refresh Token</a></li>
          </ol>
        </li>
      </ol>
      <div class="clear"></div>
    </nav>
    
    <section class="seperator offwhite">
      <h1>Terminology / Reference</h1>
      
      <ul class="nostyle padded definition">
          <li>Signed / Signature
              <ul>
                <li>String made up of several HTTP request elements in a single string.</li>
                <li>These include the <code data-title="HTTP Request Method (GET, POST, etc...). Custom methods must be encoded.">Request Method</code>  <code data-title="Seperator">&amp;</code>  <code data-title="Path and Query parts of the Requesting URL">URL</code>  <code data-title="Seperator">&amp;</code>  <code data-title="Protocol Parameters, Excluding <code>oauth_signature</code>. Normalized, sorted, and encoded.">Parameters</code>, which is then encrypted against the key which consists of: (<code>consumer_secret</code>  <code>&amp;</code>  <code>token_secret</code>). In some cases this may be the <strong>key</strong>, plaintext, or may use simply the <code>consumer_secret</code>, for RSA encryption.</li>
              </ul>
          </li>
          <li>Consumer Key
              <ul>
                  <li>Identifier string generated by API for use in OAuth 1.0 handshake. Equivalent to a username.</li>
              </ul>
          </li>
          <li>Consumer Secret
              <ul>
                  <li>Unique token generated for use in OAuth 1.0 handshake as an element of signature creation.</li>
              </ul>
          </li>
          <li>Nonce / UID
              <ul>
                  <li>Uniquely generated ID of a given length using the <span data-title="<code>a-Z0-9</code>">charset</span>, by default these are usually <code>32</code> characters long.</li>
              </ul>
          </li>
          <li>OAuth Token
              <ul>
                  <li>Token generated by the server upon signed request, can be either the <code>request_token</code> or <code>access_token</code> depending on which step in the flow you are on.</li>
              </ul>
          </li>
          <li>OAuth Token Secret
              <ul>
                  <li>This is a secret generally sent with the response for a certain token. Used for exchange, signature generation, or refreshing the <code>access_token</code>.</li>
              </ul>
          </li>
          <li>Query
              <ul>
                  <li>Part of the URL that contains key-value data invoked by the <code>?</code> symbol, the keys and values are seperated by the <code data-title="key=value">=</code> sign and each data-store is seperated by the <code>&</code> symbol:</li>
                  <li>http://httpbin.org/<code>?query=looks&amp;like=this</code></li>
              </ul>
          </li>
          <li>Parameter / Argument
              <ul>
                  <li>These are snippets of information that have a name reference such as <code>oauth_token="helloWorld"</code> where <code>oauth_token</code> is the parameter or argument and <code>helloWorld</code> is the value.</li>
              </ul>
          </li>
          <li><span data-title="Signature Encryption Method">Plaintext</span>
              <ul>
                  <li id="terminology-plaintext">No encryption method used, Human Readable text such as this line.</li>
              </ul>
          </li>
          <li><span data-title="Signature Encryption Method">HMAC-SHA1</span> [<a href="http://en.wikipedia.org/wiki/Hash-based_message_authentication_code" target="_blank">W</a>]
              <ul>
                  <li id="terminology-hmac-sha1">Secure Hash Algorithm Method.</li>
              </ul>
          </li>
          <li><span data-title="Signature Encryption Method">RSA-SHA1</span> [<a href="http://en.wikipedia.org/wiki/RSA_(algorithm)" target="_blank">W</a>]
              <ul>
                  <li id="terminology-rsa-sha1">Secure Hash Algorithm coupled with a public and private key. You may have seen this being used for your Github account at one point, or when using SSH.</li>
              </ul>
          </li>
          <li>Service
              <ul>
                  <li>Provider of information, data-source, or supplying use. Twitter is an example of a service.</li>
              </ul>
          </li>
          <li>Signature Method
              <ul>
                  <li>OAuth Accepted Encryption method, one of the following: PLAINTEXT, HMAC-SHA1, and RSA-SHA1.</li>
              </ul>
          </li>
          <li>Value
              <ul>
                  <li>Information in relation to something such as a parameter.</li>
              </ul>
          </li>
          <li>URL / URI
              <ul>
                  <li>Location on the internet or resource locator.</li>
              </ul>
          </li>
      </ul>
    </section>

    <section class="seperator" id="signed-requests">
      <h1><a href="#table-of-contents" class="pull-right">TOC</a>
        Signed Requests
      </h1>

      <section class="seperator blockquote">
        <h2>Note</h2>

        <p>This section is in regards to <strong>OAuth 1.0</strong></p>
      </section>

      <p>Signing requests is more than just the signature so in this section we will look at how the signature process should be handled and how each parameter should be used with references to flows.</p>

      <p>In this step the Application takes all the information it has gathered and generated and places it in a single location.There are two ways of transporting this information, through the <code>OAuth</code> header or <code>Query</code> string. I highly recommend going the header route for better security.</p>

      <p>Before we can generate this string we must gather all the required parameters and their values, some of these are used inside of the string directly and others in-directly through the encryption or encoding of the signature.</p>

      <h2>Signature Base String</h2>

      <p>Gathering the <code>Method</code> of the request, the <code>URL</code> of the request (or in the case of <code>OAuth Echo</code> the verify credentials uri) and the <code>Parameters</code> joined together by the <code>&</code> symbol would look like this raw (example from <a href="https://dev.twitter.com/docs/auth/creating-signature" target="_blank">twitter</a>):</p>

      <pre><code>POST&https%3A%2F%2Fapi.twitter.com%2F1%2Fstatuses%2Fupdate.json&include_entities%3Dtrue%26oauth_consumer_key%3Dxvz1evFS4wEEPTGEFPHBog%26oauth_nonce%3DkYjzVBB8Y0ZFabxSWbWovY3uYSQ2pTgmZeNu2VS4cg%26oauth_signature_method%3DHMAC-SHA1%26oauth_timestamp%3D1318622958%26oauth_token%3D370773112-GmHxMAgYyLbNEtIKZeRNFsMKPR9EyMZeS9weJAEb%26oauth_version%3D1.0%26status%3DHello%2520Ladies%2520%252B%2520Gentlemen%252C%2520a%2520signed%2520OAuth%2520request%2521</code></pre>

      <h2>Signing Key</h2>

      <p>The <code>signature base</code> string is then encrypted with a salt called the <strong>signing key</strong> which is always a joining of the OAuth <code>Consumer Secret</code> and <code>Token Secret</code> once again by the <code>&</code> character like so:</p>

      <pre><code>kAcSOqF21Fu85e7zjz7ZN2U4ZRhfV3WpwPAoE3Z7kBw<span data-title="seperator">&</span>LswwdoUaIvS8ltyTt5jkRh4J50vUPVVHtR2YPi5kE</code></pre>

      <section class="seperator blockquote">
        <h2>Note</h2>

        <p>Sometimes in case of RSA Encryption and xAuth the signing key may only be the <code>Consumer Secret</code> with the <code>&</code> symbol appended or not.</p>

        <p>For more insights check out the following lines, <a href="https://github.com/Mashape/mashape-oauth/blob/master/lib/oauth.js#L233" target="_blank">#233</a> & <a href="https://github.com/Mashape/mashape-oauth/blob/master/lib/oauth.js#L283" target="_blank">#283</a> from the <code>mashape-oauth</code> node module.</p>
      </section>


      <h2>Encoding the Signature</h2>

      <p>At last, we are able to encode our signature using these two strings of information. If you check out the terminology section you would find that there are three ways we can do this. <span data-title="#terminology-plaintext">PLAINTEXT</span>, <span data-title="#terminology-hmac-sha1">HMAC</span>, and <span data-title="#terminology-rsa-sha1">RSA</span> Encryption. Each method is slightly different, and carry their own set of pros and cons.</p>

      <h3>PLAINTEXT</h3>

      <p>Here we ignore any encoding and simply pass along the <code>Signature Key</code> as human readable text.</p>


      <h3>HMAC-SHA1</h3>

      <p>This encoding method outputs our key into binary which we update our base with, which after this step gets Base64 encoded into it's final signature string:</p>

      <pre><code>tnnArxj06cWHq44gCs1OSKk/jLY=</code></pre>

      <h3>RSA-SHA1</h3>

      <p>On the more complex side of encoding and security we have the RSA method that we have to encode the generated <code>Private Key</code> against our <code>Signature Base</code>.</p>

      <section class="seperator blockquote">
        <h2>Note</h2>

        <p>For clarification on how to pass your private key check out line <a href="https://github.com/Mashape/mashape-oauth/blob/master/tests/oauth.js#L74" target="_blank">#74</a> from the <code>mashape-oauth</code> node module.</p>
      </section>

      <p>Then on the service side they verify the public key that was generated along-side the private key against the encoded string passed as <code>oauth_signature</code>.</p>

      <h2>OAuth Header</h2>

      <p>The OAuth header is a part of the signed request, it contains the <code>oauth_signature</code> and <code>oauth_signature_method</code> parameters and their values. It is a single string and separated generally by a comma (spaces are supported here by some services, stick to comma by default unless told otherwise by the service) and named <code>Authorization</code> with <code>OAuth</code> being the Bearer, in other flows this may change such as the Mac Bearer and other similar methods.</p>

      <p>The header itself is built up by all the <code>oauth_*</code> parameters sorted (by name, then some more <a href="https://github.com/Mashape/mashape-oauth/blob/master/lib/oauth.js#L111" target="_blank">complex things</a>). Here is an example taken from Twitter for getting a Request Token:</p>

<pre><code>POST /oauth/request_token HTTP/1.1
User-Agent: themattharris' HTTP Client
Host: api.twitter.com
Accept: */*
Authorization:
        OAuth oauth_callback="http%3A%2F%2Flocalhost%2Fsign-in-with-twitter%2F",
              oauth_consumer_key="cChZNFj6T5R0TigYB9yd1w",
              oauth_nonce="ea9ec8429b68d6b77cd5600adbbb0456",
              oauth_signature="F1Li3tvehgcraF8DMJ7OyxO4w9Y%3D",
              oauth_signature_method="HMAC-SHA1",
              oauth_timestamp="1318467427",
              oauth_version="1.0"</code></pre>

      <p>The <code>oauth_callback</code> is what twitter will invoke or respond to when the authentication step happens, some services tell you they have successfully confirmed this information with a <code>oauth_callback_confirmed</code> token (This should be the de-facto situation).</p>

      <p>Now, lets see the example response:</p>

<pre lang="bash">HTTP/1.1 200 OK
Date: Thu, 13 Oct 2011 00:57:06 GMT
Status: 200 OK
Content-Type: text/html; charset=utf-8
Content-Length: 146
Pragma: no-cache
Expires: Tue, 31 Mar 1981 05:00:00 GMT
Cache-Control: no-cache, no-store, must-revalidate, pre-check=0, post-check=0
Vary: Accept-Encoding
Server: tfe

oauth_token=NPcudxy0yU5T3tBzho7iCotZ3cnetKwcTIRlX0iwRl0&
oauth_token_secret=veNRnAWe6inFuo8o2u8SLLZLjolYDmDP7SzL0YfYI&
oauth_callback_confirmed=true</pre>

      <p>Great, <code>200</code> response with the <code>oauth_token</code>, <code>oauth_token_secret</code> and <code>oauth_callback_confirmed</code> parameters. This is perfect, now you can use the <code>oauth_token_secret</code> for creating your signature for the access token and <code>oauth_token</code> for authenticating the request.</p>

      <p>Generally, the <code>oauth_token</code> will be sent along as a query parameter <code>?oauth_token=[token goes here]</code> on the authenticate endpoint when doing a <code>3-Legged OAuth 1.0a</code> request which should give you back the <code>oauth_token</code> and <code>oauth_verifier</code> which then are used as well in your  Access Token request <a href="https://dev.twitter.com/docs/auth/implementing-sign-twitter" target="_blank">[19]</a>.</p>
    </section>

    <section class="seperator" id="oauth-10a-one-legged">
      <h1><a href="#table-of-contents" class="pull-right">TOC</a>
        OAuth 1.0a (One Leg)
      </h1>

      <p>What is commonly known as two-legged is actually one legged, there is only one step, thus you are standing on one leg.</p>
      
      <section class="seperator blockquote bloodorange">
        <h2>Notice</h2>

        <p>Google requires a custom parameter that must be added to the query string of the url you are 
      request called <code>xoauth_requester_id</code> [<a href="https://developers.google.com/google-apps/gmail/oauth_protocol#oauth_request_url" target="_blank">R</a>] and many others.</p>
      </section>
      <section class="seperator blockquote">
        <p>However, they have depricated OAuth 1.0a in favor of OAuth2. So make sure you are up to date on service authentication protocols and quirky requirements as the following information may not always be all that is required.</p>
      </section>

      <img src="http://puu.sh/2pe07.png" align="right" />

      <ol>
        <li>Application sends a <strong>signed</strong> request to the Service giving it:
          <ul>
            <li><code>oauth_token</code> <em>Empty String</em></li>
            <li><code>oauth_consumer_key</code></li>
            <li><code>oauth_timestamp</code></li>
            <li><code>oauth_nonce</code></li>
            <li><code>oauth_signature</code></li>
            <li><code>oauth_signature_method</code></li>
            <li><code>oauth_version</code> <em>Optional</em></li>
          </ul>
        </li>
        <li>Service Validates and Grants Access to Resources.</li>
        <li>Application Utilizes Requested Resources</li>
      </ol>

      <p>This is probably the most quickest method of consuming an OAuth implementation however it comes with a few drawbacks on security which you can assume for yourself whether it is the best for your application.</p>
    </section>

    <section class="seperator" id="oauth-10a-two-legged">
      <h1><a href="#table-of-contents" class="pull-right">TOC</a>
        OAuth 1.0a (Two Legs)
      </h1>

      <p>The real two-legged OAuth implementation, so lucrative it's like finding a diamond in the rough. Here we also avoid the user authentication step but follow the other flows of OAuth.</p>

      <img src="http://puu.sh/2peUI.png" align="right" />

      <ol>
        <li>Application sends a <strong>signed</strong> request for a Request Token:
        <ul>
            <li><code>oauth_consumer_key</code></li>
            <li><code>oauth_timestamp</code></li>
            <li><code>oauth_nonce</code></li>
            <li><code>oauth_signature</code></li>
            <li><code>oauth_signature_method</code></li>
            <li><code>oauth_version</code> <em>Optional</em></li>
          </ul>
        </li>
        <li>Grants application Request Token:
          <ul>
            <li><code>oauth_token</code></li>
            <li><code>oauth_token_secret</code></li>
            <li>… Additional Parameters / Arguments</li>
          </ul>
        </li>
        <li>Exchange Request Token for Access Token, <strong>signed</strong> request
          <ul>
            <li><code>oauth_token</code> <em>Request Token</em></li>
            <li><code>oauth_consumer_key</code></li>
            <li><code>oauth_nonce</code></li>
            <li><code>oauth_signature</code></li>
            <li><code>oauth_signature_method</code></li>
            <li><code>oauth_version</code></li>
          </ul>
        </li>
        <li>Service grants Access Token &amp; Token Secret (same arguments generally as Step 2)</li>
        <li>Application uses <code>oauth_token</code> &amp; <code>oauth_token_secret</code> to access protected resources.</li>
      </ol>

      <p>Here is the actual flow of OAuth 1.0a 2-legged, here we can see the extra security measures in place to make sure a secure access connection has been made without bothering the user to authorize details.</p>
    </section>

    <section class="seperator" id="oauth-10a-three-legged">
      <h1><a href="#table-of-contents" class="pull-right">TOC</a>
        OAuth 1.0a (Three Legged)
      </h1>

      <p>This flow is the full experience, the grand finale, the whole shebang. It's the full-flow of OAuth 1.0a, and the most complex, excluding the other two variants on it. The user interaction in the middle of the flow is usually what causes most confusion.</p>

      <img src="http://puu.sh/2pJ4y" align="right" />

      <ol>
        <li>Application sends a <strong>signed</strong> request for a Request Token:
          <ul>
            <li><code>oauth_consumer_key</code></li>
            <li><code>oauth_timestamp</code></li>
            <li><code>oauth_nonce</code></li>
            <li><code>oauth_signature</code></li>
            <li><code>oauth_signature_method</code></li>
            <li><code>oauth_version</code> <em>Optional</em></li>
            <li><code>oauth_callback</code></li>
          </ul>
        </li>
        <li>Grants application Request Token:
          <ul>
            <li><code>oauth_token</code></li>
            <li><code>oauth_token_secret</code></li>
            <li><code>oauth_callback_confirmed</code></li>
            <li>… Additional Parameters / Arguments</li>
          </ul>
        </li>
        <li>Send user to authorize url using:
          <ul>
            <li><code>oauth_token</code></li>
          </ul>
        </li>
        <li>Prompts user to authorize / grant access</li>
        <li>User grants access</li>
        <li>Directs back to application with:
          <ul>
            <li><code>oauth_token</code></li>
            <li><code>oauth_verifier</code></li>
          </ul>
        </li>
        <li>Exchange Request Token / Verifier for Access Token, <strong>signed</strong> request
          <ul>
            <li><code>oauth_token</code> <em>Request Token;</em></li>
            <li><code>oauth_consumer_key</code></li>
            <li><code>oauth_nonce</code></li>
            <li><code>oauth_signature</code></li>
            <li><code>oauth_signature_method</code></li>
            <li><code>oauth_version</code></li>
            <li><code>oauth_verifier</code></li>
          </ul>
        </li>
        <li>Service grants Access Token &amp; Token Secret (same arguments generally as Step 2)</li>
        <li>Application uses <code>oauth_token</code> &amp; <code>oauth_token_secret</code> to access protected resources.</li>
      </ol>

      <section class="seperator blockquote bloodorange">
        <h2>Notice</h2>
        <p>On <strong>Step 6</strong> if the <code>oauth_verifier</code> has not been set, this is a failed OAuth 1.0a 3-Legged implementation and probably only requires the <code>oauth_token</code> to be sent. Rarely seen but they exist.</p>
      </section>

      <p>The most secure OAuth implementation so far, yet a little more complicated seeing as the user is a part of the handshake and must interact with interfaces during the transactions.</p>
    </section>

    <section class="seperator" id="oauth-10a-echo">
      <h1><a href="#table-of-contents" class="pull-right">TOC</a>
        OAuth 1.0a (Echo)
      </h1>

      <p>Not necessarily the most common of OAuth implementations, but it exists. Created by Raffi from twitter it uses two extra headers in the initial request token step to validate your user on their behalf by delegation.</p>

      <p>So essentially the <span data-title="Third-Party, Delegator">Service</span> will authenticate and verify the user against the originating service such as <span data-title="Origin Source">Twitter</span>.</p>

      <img src="http://puu.sh/2pKKr.png" align="right" />

      <ol>
        <li>
          <p>Application sends a signed request along with any data and:</p>
          <ul>
            <li><code>oauth_consumer_key</code></li>
            <li><code>oauth_timestamp</code></li>
            <li><code>oauth_nonce</code></li>
            <li><code>oauth_signature</code></li>
            <li><code>oauth_signature_method</code></li>
            <li><code>oauth_version</code>  <em>Optional</em></li>
            <li><code>oauth_callback</code></li>
            <p>Along with two additional headers:</p>
            <li><code>X-Auth-Service-Provider</code></li>
            <li><code>X-Verify-Credentials-Authorization</code></li>
          </ul>
        </li>
        <li>Service takes the additional headers and validates against the Origin Service.</li>
        <li>Service then validates against given information and returns protected resource information. This could be storing an image, generating the url and returning that information.</li>
      </ol>
    </section>

    <section class="seperator" id="oauth-10a-xauth">
      <h1><a href="#table-of-contents" class="pull-right">TOC</a>
        OAuth 1.0a (xAuth)
      </h1>

      <p>xAuth is a way for desktop and mobile apps to get an OAuth access token from a user’s email and password, and it is still OAuth. So the third-party will ask for your credentials on the origin service to authenticate with.</p>

      <p>The xAuth process will give back read-only, or read-write access tokens. Some limitations can apply, as in the Twitter spec Direct Messages read access is not provided and you must use the <span data-title="OAuth 1.0a Three-Legged">full flow</span>.</p>

      <section class="seperator blockquote bloodorange">
        <h2>Notice</h2>
        <p>The user's credentials should never be kept by the application requesting them.</p>
      </section>

      <a href="http://puu.sh/2qnhm.png" target="_blank"><img src="http://puu.sh/2qneC.png" align="right" vspace="15px" /></a>

      <ol>
        <li>Application Requests User Credentials</li>
        <li>
          <p>Application creates signed request for Access Token:</p>
          <ul>
            <li><code>oauth_consumer_key</code></li>
            <li><code>oauth_timestamp</code></li>
            <li><code>oauth_nonce</code></li>
            <li><code>oauth_signature</code></li>
            <li><code>oauth_signature_method</code></li>
            <li><code>oauth_version</code>  <em>Optional</em></li>
            <li><code>oauth_callback</code></li>
              <p>Along with additional parameters:</p>
            <li><code>x_auth_mode</code> = <code>client_auth</code></li>
            <li><code>x_auth_username</code></li>
            <li><code>x_auth_password</code></li>
            <li><code>x_auth_permission</code>  <em>Optional;</em> Scope of the requested token <a href="http://developer.vimeo.com/apis/advanced" target="_blank">[17]</a>
            </li>
          </ul>
        </li>
        <li>Service validates user details and grants Access Token
          <ul>
            <li><code>oauth_token</code></li>
            <li><code>oauth_token_secret</code></li>
          </ul>
        </li>
        <li>Application uses Access Token to retrieve protected resources.</li>
      </ol>
    </section>

    <section class="seperator" id="oauth-10a-three-legged" hidden>
      <h1><a href="#table-of-contents" class="pull-right">TOC</a>
        OAuth 1.0a (Three Legged)
      </h1>
    </section>
  </section>

  <script src="http://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
  <script src="assets/js/just.the.tip.js" charset="utf-8"></script>

  <script>
    $('[data-title]').each(function () {
      $(this).justTheTip().arrow(11).pos('top').attr(['data-title']);
    });
  </script>
</body>
</html>